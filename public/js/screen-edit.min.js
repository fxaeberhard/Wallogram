jQuery(function(d){YUI_config.groups.inputex.base="libs/inputEx/src/";YUI_config.groups.inputex.filter="raw";YUI_config.groups.inputex.modules["inputex-rte"].requires=["inputex-field","inputex-textarea"];YUI_config.groups.inputex.modules["inputex-color"].requires=["inputex-field"];var a,b={Color:{tab:"platforms",label:"Colored platform",form:[{name:"color",label:"Color",type:"color"}],value:{components:"ColoredPlatform",color:"red",w:100,h:100}},Invisible:{tab:"platforms",label:"Invisible platform",form:[],value:{components:"Invisible",w:100,h:100}},Image:{tab:"image",thumbClass:"fa fa-file-image-o fa-4x",form:[{name:"image",label:"Image"}],value:{components:"WalloImage, Platform",image:"assets/mario-platform.png",w:90,h:100}},Video:{tab:"video",thumbClass:"fa fa-file-video-o fa-4x",form:[{name:"url",label:"Url",type:"url"}],value:{components:"Video",url:"http://www.youtube.com/watch?v=xhrBDcQq2DM",w:320,h:280}},Text:{tab:"other",thumbClass:"fa fa-font fa-4x",form:[{name:"text",type:"html",className:"inputEx-Field form-text"}],value:{components:"WalloText",text:"Ipsem lorum",w:200,h:80}},QR:{tab:"other",thumbClass:"fa fa-qrcode fa-4x",form:[{name:"background",label:"Background",type:"color"},{name:"foreground",label:"Foreground",type:"color"}],value:{components:"QR",w:80,h:80,foreground:"#000000",background:"#ffffff"}},Lab_Porte:{tab:"platforms",thumbUrl:"assets/lab/porte.png",value:{components:"Lab_Porte",w:120,h:170}},Gyrophare:{tab:"furniture",thumbUrl:"assets/lab/sprite_gyrophare_thumb.png",value:{components:"Gyrophare",w:80,h:80}},Chimie:{tab:"platforms",thumbUrl:"assets/lab/sprite_chimie_thumb.png",value:{components:"Chimie",w:160,h:160}},Jauge:{tab:"platforms",thumbUrl:"assets/lab/sprite_jauge_thumb.png",value:{components:"Jauge",w:182,h:153}},Ventilo:{tab:"furniture",thumbUrl:"assets/lab/sprite_ventilo_thumb.png",value:{components:"Ventilo",w:202,h:204}},Serveur:{tab:"platforms",thumbUrl:"assets/lab/sprite_serveur_thumb.png",value:{components:"Serveur",w:115,h:180}},Lab_Falling:{tab:"platforms",thumbUrl:"assets/lab/sprite_plateforme_tombe_thumb.png",value:{components:"Lab_Falling",w:128,h:100}},Lab_Plateform1:{tab:"platforms",thumbUrl:"assets/lab/sprite_plateforme1.png",value:{components:"2D, Canvas, lab_plateforme1, MouseHover",w:128,h:128}}},c={init:function(){d(".wallo-crafty").prepend('<div class="wallo-edit-overlay"><div class="wallo-edit-dd"><div class="wallo-edit-menu"><div class="wallo-edit-destroy fa fa-trash"></div><div class="wallo-edit-editentity fa fa-pencil"></div></div></div></div>');var k=false,j=false,f=d(".wallo-edit-dd"),i={containment:".wallo-crafty",handles:"ne, se, sw, nw",start:function(){c.isDragging=true},resize:function(){c.savePositions()},drag:function(){c.savePositions()},stop:function(){console.log("EditOverlay.stopDrag(over: "+j+")");c.savePositions();c.isDragging=false;if(!j){c.hideEdition()}}};f.draggable(i);f.resizable(i);f.on("mouseenter",function(){console.log("mouseenter");j=true});f.on("mouseleave",function(){console.log("mouseleave(isDragging: "+c.isDragging+")");j=false;if(!c.isDragging){c.hideEdition()}});d(".wallo-edit-editentity").click(c.showEditForm);d(".wallo-edit-destroy").click(c.destroyEntity);d(document).on("newGameCreated",function(){var p=d.App.getPadUrl();d(".wallo-tab-footer").prepend("Pad: <a href='"+p+"' target='_blank'>"+p+"</a><br /> <br />")});var g=new Stats();d(g.domElement).hide();d(".wallo-tab-footer").append(g.domElement);g.begin();Crafty.bind("RenderScene",function(){g.end();g.begin()});d(".wallo-edit-logo").click(function(){window.location="/lobby"});d(".button-togglefps").click(function(){d("#stats").toggle()});d(".wallo-edit-buttons .button-save").click(c.save);d(".wallo-edit-toggle").on("click",function(){d.App.toggleDebug()});d(".wallo-edit-buttons .button-more").click(function(){var p=d(this).next().show().position({my:"left top",at:"left bottom",of:this});d(document).one("click",function(){p.hide()});return false}).next().hide().css("position","absolute").css("width","220px").menu();d(".wallo-edit-buttons .button-adddebugplayer").click(d.App.addDebugPlayer);d(".wallo-edit-buttons .button-toggledebugcanvas").click(d.App.toggleDebugCanvas);var h,n,o=true;d(".wallo-tab-link").on("click",function(){d(".wallo-tab-linkselected").removeClass("wallo-tab-linkselected");d(this).addClass("wallo-tab-linkselected");d(".wallo-tab-selected").removeClass("wallo-tab-selected");d(this.dataset.target).addClass("wallo-tab-selected");switch(this.dataset.target){case"#tab-source":if(!h){h=ace.edit("editor");h.getSession().setMode("ace/mode/json");h.getSession().on("change",function(p){if(o){try{d.App.setCfg(JSON.parse(h.getValue()))}catch(p){console.error("Unable to parse source",p)}}})}h.focus();o=false;h.setValue(JSON.stringify(d.App.cfg,null,"\t"));o=true;h.gotoLine(0,0);break;case"#tab-script":if(!n){n=ace.edit("scripteditor");n.getSession().setMode("ace/mode/javascript");n.getSession().on("change",function(p){if(o){}})}n.focus();o=false;n.setValue("");o=true;n.gotoLine(0,0);break;case"#tab-play":d.App.resetCrafty();break}});var m,e,l={platforms:"",furniture:"",ennemy:"",image:"",video:"",other:""};_.each(b,function(q,s){if(!l[q.tab]){l[q.tab]=""}var p,r="";if(q.thumbUrl){p="<img src='"+q.thumbUrl+"' />";r="wallo-thumb-img"}else{p="<div class='wallo-icon "+q.thumbClass+"'></div>"}l[q.tab]+="<div class='wallo-thumb wallo-thumb-"+s+" "+r+"' data-type='"+s+"' title='"+(q.label||s)+"'>"+p+"</div>"});m=_.map(l,function(q,p){return'<li><a href="#tabs-toolbar-'+p+'" class="toolbar-'+p+'"></a></li>'});e=_.map(l,function(q,p){return"<div id='tabs-toolbar-"+p+"'>"+q+"</div>"});d(".wallo-edit-toolbar").append("<ul>"+m.join("")+"</ul>"+e.join("")).tabs();d(".wallo-edit-toolbar .wallo-thumb").draggable({opacity:0.7,helper:"clone"});d(".wallo-play").droppable({drop:function(s){console.log(s,s.originalEvent.target.className);if(s.originalEvent.target.className.indexOf("edit-dd")!==-1){return}try{var r=d(s.originalEvent.target).closest(".wallo-thumb").attr("data-type"),p=_.clone(b[r].value);p.x=s.clientX-d("#tab-play").position().left-p.w/2;p.y=s.clientY-p.h/2;p.type=r;d.App.cfg.entities.push(p);var q=Crafty.e(p.components).attr(p);q.cfg=p}catch(s){console.log("Unable to drop new object",s)}}})},showEditOverlay:function(e){if(!c.isDragging){d(".wallo-edit-overlay").show();d(".wallo-edit-dd").css("left",e.x).css("top",e.y).width(e.w).height(e.h);a=e}},hideEdition:function(){console.log("Edit.hideEdition(isDragging:"+c.isDragging+")");if(!c.isDragging){d(".wallo-edit-overlay").hide()}},savePositions:function(){var f=d(".wallo-edit-dd"),e={x:f.position().left,y:f.position().top,w:f.width(),h:f.height()};a.attr(e);d.extend(a.cfg,e)},showEditForm:function(){var g,f=d("<div></div>").dialog({modal:true,width:700,position:{my:"center top",at:"center top+75"},buttons:[{text:"Save",click:function(){d.App.updateEntityCfg(a,g.getValue());d(this).dialog("close")}},{text:"Cancel",click:function(){d(this).dialog("close")}}]}),e={type:"group",fields:b[a.cfg.type].form,parentEl:f.get(0),value:a.cfg};d(".wallo-edit-overlay").hide();YUI().use("inputex","inputex-color",function(h){h.inputEx.use(e,function(i){g=i.inputEx(e)})})},destroyEntity:function(){console.log("Edit.destroyEntity()");d.arrayFind(d.App.cfg.entities,function(f,g){if(g===a.cfg){d.App.cfg.entities.splice(f,1);return true}});a.destroy();a=null;c.hideEdition();c.save()},save:function(){d.ajax({type:"PUT",data:JSON.stringify(d.App.cfg),url:"/levels/updateLevel",dataType:"JSON",contentType:"application/json"}).done(function(e){if(e.msg===""){console.log("level saved")}else{alert("Error: "+e.msg)}})}};d.Edit=c}($));